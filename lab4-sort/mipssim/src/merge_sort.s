.text
main:
    ADDIU   $r4,    $r0,    a       # $r4 = 数组a基地址
    ADDIU   $r5,    $r0,    n       # $r1 = n的地址
    LW      $r5,    0($r5)          # $r5 = 数组长度n
    SLL     $r5,    $r5,    2       # $r5 = n*4 (字节数)
    ADDIU   $r6,    $r0,    4       # size = 1元素(4字节)
    ADDIU   $r20,   $r0,    b       # $r20 = 临时数组基地址

loop_size:
    SLT     $r1,    $r6,    $r5     # 比较size < n*4?
    BEQZ    $r1,    _END_SORT       # size >=n*4时结束
    ADDIU   $r7,    $r0,    0       # i=0 (字节偏移)

# left  -> $r7
# mid   -> $r8
# right -> $r9
loop_i:
    SLT     $r1,    $r7,    $r5     # i < n*4?
    BEQZ    $r1,    _END_I          # i越界时结束循环
    ADDU    $r8,    $r7,    $r6     # mid = i + size
    ADDU    $r9,    $r8,    $r6     # right = i + 2*size

    SLT     $r1,    $r8,    $r5     # mid <n*4?
    BEQZ    $r1,    _NEXT_I         # 无右半区时跳过
    SLT     $r1,    $r9,    $r5     # right <n*4?
    BNEZ    $r1,    _MERGE_START
    ADDU    $r9,    $r5,    $r0     # right =n*4，取 min

# iptr -> $r10
# jptr -> $r11
# tptr -> $r13
# llim -> $r1
# rlim -> $r12
_MERGE_START:                       # 合并流程开始
    ADDU    $r10,   $r4,    $r7     # 左指针
    ADDU    $r11,   $r4,    $r8     # 右指针
    ADDU    $r12,   $r4,    $r9     # 右边界
    ADDU    $r13,   $r20,   $r0     # temp指针
    ADDU    $r1,    $r4,    $r8     # 左边界

_MERGE_LOOP:                        # 合并循环
    SLT     $r2,    $r10,   $r1     # 左指针 < 左边界?
    BEQ     $r2,    $r0,    _COPY_RIGHT
    SLT     $r2,    $r11,   $r12    # 右指针 < 右边界?
    BEQ     $r2,    $r0,    _COPY_LEFT

    LW      $r14,   0($r10)         # 加载左值 $r14
    LW      $r15,   0($r11)         # 加载右值 $r15
    SLT     $r16,   $r14,   $r15    # 比较左右值
    BNE     $r16,   $r0,    _TAKE_LEFT

_TAKE_RIGHT:
    SW      $r15,   0($r13)         # 存储右值到temp
    ADDIU   $r11,   $r11,   4       # 右指针+4
    B       _NEXT_TEMP

_TAKE_LEFT:
    SW      $r14,   0($r13)         # 存储左值到temp
    ADDIU   $r10,   $r10,   4       # 左指针+4

_NEXT_TEMP:
    ADDIU   $r13,   $r13,   4       # temp指针+4
    B       _MERGE_LOOP

_COPY_LEFT:                         # 复制左剩余元素
    BEQ     $r10,   $r1,    _COPY_DONE
    LW      $r14,   0($r10)
    SW      $r14,   0($r13)
    ADDIU   $r10,   $r10,   4
    ADDIU   $r13,   $r13,   4
    B       _COPY_LEFT

_COPY_RIGHT:                        # 复制右剩余元素
    BEQ     $r11,   $r12,   _COPY_DONE
    LW      $r15,   0($r11)
    SW      $r15,   0($r13)
    ADDIU   $r11,   $r11,   4
    ADDIU   $r13,   $r13,   4
    B       _COPY_RIGHT

_COPY_DONE:                         # 数据回写
    SUBU    $r17,   $r9,    $r7     # 计算拷贝长度
    ADDU    $r14,   $r4,    $r7     # 目标地址
    ADDU    $r15,   $r20,   $r0     # 源地址

_COPY_BACK:
    BEQ     $r17,   $r0,    _NEXT_I
    LW      $r18,   0($r15)
    SW      $r18,   0($r14)
    ADDIU   $r15,   $r15,   4
    ADDIU   $r14,   $r14,   4
    ADDIU   $r17,   $r17,   -4
    B       _COPY_BACK

_NEXT_I:
    ADDU    $r7,    $r7,    $r6     # i += size*2
    ADDU    $r7,    $r7,    $r6
    B       loop_i

_END_I:
    SLL     $r6,    $r6,    1       # size *=2
    B       loop_size

_END_SORT:
    TEQ     $r0,    $r0

.data
a:  .word
 768, 209, 577, 587, 127, 468, 539, 843, 201, 411,
 968, 805, 856, 493, 400, 596, 629, 422, 127, 595,
 667, 894, 554, 378, 856, 178, 292, 941, 494, 250,
 285, 864, 373, 496, 285, 138, 342, 721, 784, 294,
 339, 271, 294, 327, 641, 400, 977, 284, 814, 136,
 475, 629, 818, 888, 787, 540, 872, 236, 953, 541,
 484, 879, 186, 560, 975, 241, 508, 995, 241, 444,
 795, 963, 115, 156, 613, 303, 638, 550, 503, 356,
 272, 564, 454, 311, 738, 835, 329, 992, 983, 527,
 925, 581, 294, 426, 614, 453, 767, 292, 209, 692,
 436, 620, 425, 328, 898, 119, 532, 764, 152, 106,
 189, 446, 810, 677, 383, 690, 469, 467, 205, 276,
 175, 519, 576, 700, 189, 167, 942, 792, 327, 135,
 337, 410, 232, 834, 258, 209, 155, 265, 260, 303,
 938, 129, 370, 363, 479, 538, 233, 625, 392, 435,
 757, 113, 903, 262, 897, 314, 928, 277, 433, 194,
 393, 681, 971, 383, 497, 714, 176, 910, 793, 722,
 338, 989, 638, 574, 283, 520, 764, 206, 331, 829,
 982, 823, 858, 585, 488, 744, 263, 311, 571, 720,
 580, 832, 951, 635, 899, 797, 613, 208, 805, 591
b:  .word  # .space 伪指令无效
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
n:  .word
 200
